2026-02-08 23:07:49,669 - INFO - >>> INICIANDO CREACIËN DE ESQUEMAS <<<
2026-02-08 23:07:49,698 - INFO - Forzando eliminaci¾n de esquemas antiguos...
2026-02-08 23:07:49,735 - INFO - Exec: V4__stage_schema_redesign.sql...
2026-02-08 23:07:49,812 - INFO - \u2705 V4__stage_schema_redesign.sql completado.
2026-02-08 23:07:49,812 - INFO - Exec: V4__referencial_schema_redesign.sql...
2026-02-08 23:07:49,937 - INFO - \u2705 V4__referencial_schema_redesign.sql completado.
2026-02-08 23:07:49,937 - INFO - Exec: V1__universal_schema.sql...
2026-02-08 23:07:49,967 - INFO - \u2705 V1__universal_schema.sql completado.
2026-02-08 23:07:49,968 - INFO - Exec: V4__reporting_schema_redesign.sql...
2026-02-08 23:07:50,092 - INFO - \u2705 V4__reporting_schema_redesign.sql completado.
2026-02-08 23:07:50,092 - INFO - Exec: V6.1__historical_reporting_engine_v4.sql...
2026-02-08 23:07:50,137 - INFO - \u2705 V6.1__historical_reporting_engine_v4.sql completado.
2026-02-08 23:07:50,137 - INFO - Exec: V6.2__dq_engine_v4.sql...
2026-02-08 23:07:50,137 - INFO - \u2705 V6.2__dq_engine_v4.sql completado.
2026-02-08 23:07:50,137 - INFO - Exec: V6.3__sync_dim_pozo_targets_v4.sql...
2026-02-08 23:07:50,137 - INFO - \u2705 V6.3__sync_dim_pozo_targets_v4.sql completado.
2026-02-08 23:07:50,137 - INFO - Exec: V6__stored_procedures_v4_compatible.sql...
2026-02-08 23:07:50,188 - INFO - \u2705 V6__stored_procedures_v4_compatible.sql completado.
2026-02-08 23:07:50,196 - INFO - >>> BD INICIALIZADA CORRECTAMENTE <<<
>>> Carga Maestra de Variables (STRICT IDs) y Metadatos...
>>> Carga de Reglas DQ y RC...
>>> Carga de LÝmites Operativos (Strict matching with Rangos)...
    LÝmites cargados: 17
>>> Sincronizaci¾n de Mapa SCADA...
=== REFERENCIAL V4 (STRICT & INTEGRATED) CARGADO CORRECTAMENTE ===
2026-02-08 23:07:52,316 - INFO - ====================================================
2026-02-08 23:07:52,316 - INFO - >>> INGESTA H═BRIDA + LANDING SCADA (SQL)
2026-02-08 23:07:52,316 - INFO - ====================================================
2026-02-08 23:07:52,316 - INFO - \U0001f4c2 Ejecutando SQL: tbl_maestra_202602021632.sql
2026-02-08 23:07:52,347 - INFO - \u2705 OK: tbl_maestra_202602021632.sql
2026-02-08 23:07:52,347 - INFO - \U0001f4c2 Ejecutando SQL: tbl_pozo_produccion_202602021632.sql
2026-02-08 23:07:52,352 - INFO - \u2705 OK: tbl_pozo_produccion_202602021632.sql
2026-02-08 23:07:52,353 - INFO - \U0001f4d8 Ingestando RESERVAS desde Excel...
2026-02-08 23:07:52,558 - INFO - \u2705 Reservas insertadas correctamente desde Excel.
2026-02-08 23:07:52,558 - INFO - \U0001f4c2 Ejecutando SQL: landing_scada_data_202602021604.sql
2026-02-08 23:07:52,608 - INFO - \u2705 OK: landing_scada_data_202602021604.sql
2026-02-08 23:07:52,608 - INFO - >>> INGESTA COMPLETA <<<
============================================================
STARTING MASTER PIPELINE ORCHESTRATION
Python Executable: auditor\Scripts\python.exe
============================================================

>>> 1. Re-initializing Schemas (Full Reset)...
[OK] Init Schemas completed.

>>> 1.5 Loading Referencial Master (Variables, Rangos, Mapas SCADA)...
[OK] Referencial Master Loaded.

>>> 2. Ingesting Real Telemetry (SQL Dumps)...
[OK] Ingestion completed.

>>> 3. Loading Universal Logic Engine (V5)...
[SKIP] V5 Logic skipped (Covered by V6 in init_schemas).

>>> 3.1 Running Data Quality Engine (V5 DQ)...
[OK] Data Quality Validation completed.

>>> 3.5 Loading Reporting Engine V2...
[SKIP] Reporting Engine V2 skipped (Covered by V6.1 in init_schemas).

>>> 5. Running Reporting Load (Daily, Hourly, Monthly)...
[OK] History loaded.

>>> 5.5 Loading Business KPIs...
[OK] Business KPIs loaded.

>>> 6. Updating Snapshot (dataset_current_values)...
[ERROR] Query Failed: CALL reporting.actualizar_current_values_v4();
Details: (psycopg2.errors.UndefinedColumn) column lim.fill_min_warn does not exist
LINE 71:             lim.fill_min_warn,
                     ^
QUERY:  WITH calc AS (
        SELECT 
            curr.well_id,
            dp.road_load_status_eff_low  AS rl_min_legacy, -- Fallback si no estß en view
            dp.road_load_status_eff_high AS rl_max_legacy,
            
            -- WHP
            res_whp.color_hex       AS whp_color,
            res_whp.nivel_severidad AS whp_sev,
            
            -- SPM
            res_spm.color_hex       AS spm_color,
            res_spm.variacion_pct   AS spm_var,
            res_spm.target_value    AS spm_target_calc,
            
            -- FILL
            res_fill.color_hex      AS fill_color,
            res_fill.target_value   AS fill_target_calc,
            res_fill.variacion_pct  AS fill_var,
            
            -- MTBF
            res_mtbf.color_hex      AS mtbf_color,
            res_mtbf.variacion_pct  AS mtbf_var,
            
            -- ROAD LOAD (Calculado aquÝ por ahora, ya que depende de % carga varilla que no estß directo en curr)
            -- Asumiremos que rod_weight_buoyant_lb_act ES el valor a comparar, o necesitamos convertir a PCT.
            -- En V5: `road_load_pct_act` (columna) se comparaba.
            -- En V4: `rod_weight_buoyant_lb_act` es LB. ┐D¾nde estß `road_load_pct_act`?
            -- Si falta en V4 Dataset, usamos l¾gica simple o asumimos existe. 
            -- Verificando V4 Schema: `road_load_pct_act` EXISTE en V3, ┐renombrada en V4? 
            -- Mantenemos `road_load_pct_act` si existe, o calculamos.
            -- Asumiremos `road_load_pct_act` en dataset.
            
            -- Targets estßticos
            lim.spm_target          AS spm_target_lim,
            lim.fill_target_val     AS fill_target_lim,
            lim.rl_min_warn         AS rl_min_lim,
            lim.rl_max_warn         AS rl_max_lim

        FROM reporting.dataset_current_values curr
        LEFT JOIN reporting.dim_pozo dp ON curr.well_id = dp.pozo_id -- Para legacy targets si view falla
        LEFT JOIN referencial.vw_limites_pozo_pivot_v4 lim
            ON curr.well_id = lim.pozo_id
        
        -- WHP (well_head_pressure_psi_act)
        CROSS JOIN LATERAL referencial.fnc_evaluar_universal(
            curr.well_head_pressure_psi_act, 
            lim.whp_min_crit,
            lim.whp_min_warn,
            lim.whp_max_warn,
            lim.whp_max_crit, 
            NULL::DECIMAL,
            NULL::DECIMAL
        ) AS res_whp
        
        -- SPM (pump_avg_spm_act)
        CROSS JOIN LATERAL referencial.fnc_evaluar_universal(
            curr.pump_avg_spm_act, 
            NULL::DECIMAL,
            NULL::DECIMAL,
            NULL::DECIMAL,
            NULL::DECIMAL, 
            lim.spm_target,
            lim.spm_tol
        ) AS res_spm
        
        -- FILL (pump_fill_monitor_pct)
        CROSS JOIN LATERAL referencial.fnc_evaluar_universal(
            curr.pump_fill_monitor_pct, 
            lim.fill_min_crit,
            lim.fill_min_warn,
            lim.fill_max_warn,
            lim.fill_max_crit, 
            NULL::DECIMAL,
            NULL::DECIMAL
        ) AS res_fill

    
        -- MTBF (kpi_mtbf_hrs_act)
        CROSS JOIN LATERAL referencial.fnc_evaluar_universal(
            curr.kpi_mtbf_hrs_act, 
            NULL::DECIMAL,
            NULL::DECIMAL,
            NULL::DECIMAL,
            NULL::DECIMAL, 
            dp.mtbf_target, -- From Dim Pozo
            10.0 -- Tolerance default (hardcoded or from rules?)
        ) AS res_mtbf

    )
    
    -- C. UPDATE ┌NICO SOBRE DATASET_CURRENT_VALUES (Nombres V4)
    UPDATE reporting.dataset_current_values tgt
    SET 
        -- WHP
        whp_status_color = c.whp_color,
        dq_status = CASE
            WHEN c.whp_sev >= 3 THEN 'FAIL'
            ELSE 'PASS'
        END,
        
        -- SPM
        pump_spm_status_color = c.spm_color,
        spm_target            = c.spm_target_calc,
        pump_avg_spm_act      = tgt.pump_avg_spm_act,
        pump_spm_var_pct      = c.spm_var,  -- [UPDATED] Populating Variance
        
        -- FILL
        pump_fill_monitor_status_color = c.fill_color,
        pump_fill_monitor_target       = c.fill_target_lim,
        pump_fill_monitor_var          = c.fill_var, -- [UPDATED] Populating Variance
        
        -- MTBF
        mtbf_status_color     = c.mtbf_color,
        mtbf_variance_pct     = c.mtbf_var, -- [UPDATED] Populating Variance
        
        -- ROAD LOAD (Restaurado V5 Logic)
        road_load_status_color = CASE
             WHEN tgt.road_load_pct_act IS NULL THEN '#B0B0B0'
             WHEN (tgt.road_load_pct_act < COALESCE(c.rl_min_lim, 0) OR tgt.road_load_pct_act > COALESCE(c.rl_max_lim, 100)) 
                 THEN '#FF4444' -- CRITICAL
             WHEN (tgt.road_load_pct_act >= (COALESCE(c.rl_max_lim, 100) - 5) AND tgt.road_load_pct_act <= COALESCE(c.rl_max_lim, 100)) 
                 THEN '#FFBB33' -- WARNING
             ELSE '#00C851' -- NORMAL
        END,
        road_load_status_legend_text = CONCAT(COALESCE(c.rl_min_lim,0), '% <= Target <= ', COALESCE(c.rl_max_lim,100), '%'),
        
        -- Estado de comunicaci¾n
        color_estado_comunicacion = CASE 
            WHEN EXTRACT(EPOCH FROM (NOW() - tgt.ultima_actualizacion))/60 > 60
                THEN '#B0B0B0' -- OFFLINE
            ELSE '#00C851'    -- NORMAL
        END
    FROM calc c
    WHERE tgt.well_id = c.well_id
CONTEXT:  PL/pgSQL function reporting.actualizar_current_values_v4() line 99 at SQL statement

[SQL: CALL reporting.actualizar_current_values_v4();]
(Background on this error at: https://sqlalche.me/e/20/f405)
